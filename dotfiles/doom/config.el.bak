;;; $DOOMDIR/config.el -*- lexical-binding: t; -*-

;; ── User / UI ─────────────────────────────────────────────────────────────────
(setq user-full-name "Deniz"
      user-mail-address "deniz060198@hotmail.com")

(setq doom-theme 'doom-one
      display-line-numbers-type 'relative)   ; 't oder 'relative

;; Fonts
(setq doom-font (font-spec :family "JetBrainsMono Nerd Font" :size 14)
      doom-variable-pitch-font (font-spec :family "JetBrainsMono Nerd Font" :size 14)
      ;; optional, aber hilfreich für spezielle Icons:
      doom-symbol-font (font-spec :family "Symbols Nerd Font Mono" :size 14))

;; ── Org ──────────────────────────────────────────────────────────────────────
(after! org
  ;; Startzustand
  (setq org-directory "~/org"
        org-startup-folded 'content   ; nur Überschriften sichtbar (Text eingeklappt)
        org-startup-indented t        ; visuelles Einrücken nach Überschrift-Ebene
        org-ellipsis " ▾ "            ; hübscher Fold-Indikator
        org-hide-emphasis-markers t   ; *bold* zeigt nur bold, nicht die Sternchen
        org-pretty-entities t)        ; z.B. \alpha schöner anzeigen

  ;; besserer Lesefluss
  (add-hook 'org-mode-hook #'visual-line-mode))

;; ── Projekte / Workspaces ────────────────────────────────────────────────────

(setq projectile-project-search-path '("~/code" "~/projects" "~/nixos-config"))

(setq +workspaces-on-switch-project-behavior t
      +workspaces-auto-save t)

(after! doom-modeline
  (setq doom-modeline-persp-name t
        doom-modeline-display-default-persp-name t))

(after! persp-mode
  (setq persp-emacsclient-init-frame-behaviour-override "main")

  ;; --- main clean policy: was darf in main bleiben? ---
  (defconst my/main-keep-buffer-names
    '("*doom*" "*scratch*" "*Messages*")
    "Buffers that are always allowed in main.")

  (defun my/main-allowed-buffer-p (buf)
    "Return non-nil if BUF is allowed to stay in the 'main' workspace."
    (with-current-buffer buf
      (or (member (buffer-name buf) my/main-keep-buffer-names)
          ;; Terminals ausdrücklich erlauben (wichtig!)
          (derived-mode-p 'vterm-mode 'eshell-mode 'term-mode 'shell-mode)
          ;; nicht-Datei buffers (help/transient/etc.) sind ok
          (null buffer-file-name))))

  (defun my/main-persp ()
    "Return the persp object for workspace 'main' if possible."
    (cond ((fboundp '+workspace-get) (+workspace-get "main"))
          ((fboundp 'persp-get-by-name) (persp-get-by-name "main"))
          (t nil)))

  (defun my/prune-main-buffers ()
    "Remove non-allowed buffers from 'main' (do not kill)."
    (when (and (fboundp 'persp-remove-buffer)
               (fboundp 'persp-buffers))
      (when-let ((p (my/main-persp)))
        (dolist (buf (persp-buffers p))
          (when (and (buffer-live-p buf)
                     (not (my/main-allowed-buffer-p buf)))
            (persp-remove-buffer buf p)))))))

(after! projectile
  ;; Wenn du aus main heraus per vterm (oder irgendwas) `SPC p p` machst,
  ;; wandern gern Projekt-Buffers in main -> direkt danach main aufräumen.
  (defun my/after-projectile-switch-project-clean-main (&rest _)
    (run-at-time 0 nil #'my/prune-main-buffers))

  (advice-add 'projectile-switch-project :after #'my/after-projectile-switch-project-clean-main))

;; Projectile spezifische Einstellungen
(after! projectile
  (setq projectile-indexing-method 'hybrid)

  (defun my/projectile-buffers-same-root (buffers)
    "Keep only buffers whose *own* Projectile root equals the current Projectile root."
    (let* ((cur-root (when (projectile-project-p)
                       (file-truename (projectile-project-root)))))
      (seq-filter
       (lambda (buf)
         (with-current-buffer buf
           (let* ((f (buffer-file-name))
                  (dir (or (and f (file-name-directory f))
                           default-directory))
                  (buf-root (ignore-errors
                              (let ((default-directory dir))
                                (projectile-project-root)))))
             (and cur-root buf-root
                  (string= (file-truename buf-root) cur-root)))))
       (projectile-buffers-with-file-or-process buffers))))

  (setq projectile-buffers-filter-function #'my/projectile-buffers-same-root)

  (defun my/projectile-kill-buffer ()
    "Kill one buffer belonging to the current Projectile project."
    (interactive)
    (let* ((bufs (projectile-project-buffers))
           (names (mapcar #'buffer-name bufs))
           (choice (completing-read "Kill project buffer: " names nil t)))
      (when-let ((b (get-buffer choice)))
        (kill-buffer b)
        (message "Killed: %s" choice))))

  (map! :leader
        :desc "Kill project buffer" "p K" #'my/projectile-kill-buffer))

;; ── Tabs ─────────────────────────────────────────────────────────────────────
;; (map! :leader
;;       :prefix ("TAB" . "tabs")
;;       :desc "New tab"     "n" #'tab-bar-new-tab
;;       :desc "Close tab"   "c" #'tab-bar-close-tab
;;       :desc "Next tab"    "]" #'tab-bar-switch-to-next-tab
;;       :desc "Prev tab"    "[" #'tab-bar-switch-to-prev-tab
;;       :desc "Rename tab"  "r" #'tab-bar-rename-tab
;;       :desc "Switch tab"  "s" #'tab-bar-switch-to-tab)

;; ── consult-fd ───────────────────────────────────────────────────────────────
(after! consult
  (map! :leader :desc "Find file (consult-fd)" "f z" #'consult-fd))

;; ── Treemacs / Dired Convenience ─────────────────────────────────────────────
;; Toggle-Key für Treemacs
(map! :leader :desc "Toggle treemacs" "t t" #'+treemacs/toggle)
;; Dired: hjkl-Navigation
(with-eval-after-load 'dired
  (map! :map dired-mode-map
        :n "h" #'dired-up-directory
        :n "l" #'dired-find-file))

;; ── LSP / Tree-sitter / Format ───────────────────────────────────────────────
(after! lsp-mode
  (setq lsp-headerline-breadcrumb-enable t
        lsp-lens-enable t
        lsp-inlay-hints-enable t
        lsp-idle-delay 0.25
        lsp-log-io nil))

;; On-save-Formatter (Doom builtin). Wähle, ob per LSP oder externe Tools.
(setq +format-with-lsp t)
;; Begrenze, wo auto-format wirklich laufen soll:
(setq +format-on-save-enabled-modes
      '(lua-mode nix-mode python-mode json-mode yaml-mode sh-mode))

;; Tree-sitter: bevorzugte Major-Modes (abhängig von Doom-Version)
(setq treesit-font-lock-level 4)

;; ── Direnv (für Nix- / devShells) ────────────────────────────────────────────
;; Aktiv: :tools direnv (Modul)
;; Keine Extra-Config nötig, aber falls du Probleme mit env hast:
;; (setq direnv-always-show-summary t)

;; ── Terminals ────────────────────────────────────────────────────────────────
(map! :leader :desc "vterm" "o t" #'vterm)
(with-eval-after-load 'vterm
  (evil-set-initial-state 'vterm-mode 'emacs)
  (add-hook 'vterm-mode-hook #'evil-emacs-state))

;; ── Completion QoL (corfu + orderless, vertico) ──────────────────────────────
;; Orderless Feinheiten
(with-eval-after-load 'orderless
  (setq orderless-component-separator #'orderless-escapable-split-on-space))

;; ── Git / Magit ──────────────────────────────────────────────────────────────
(map! :leader :desc "Magit status" "g g" #'magit-status)

;; ── Spell ────────────────────────────────────────────────────────────────────
(use-package! jinx
  :hook ((text-mode org-mode markdown-mode) . jinx-mode)
  :bind (("M-$" . jinx-correct)
         ("C-M-$" . jinx-languages)))

;; ── Eigene Helfer laden (für projekt-spezifische Minor-Modes etc.) ──────────
;; Lege deine .el-Dateien in $DOOMDIR/lisp/ und aktiviere sie per .dir-locals.el
(add-to-list 'load-path (expand-file-name "lisp" doom-user-dir))

;; Beispiel: Awesome-Auto-Reload wird per .dir-locals.el im Awesome-Projekt aktiviert:
;; ~/.config/awesome/.dir-locals.el:
;; ((lua-mode . ((eval . (progn (require 'awesome-dev)
;;                              (awesome-dev-mode 1))))))

;; ── Optional: Sprache-spezifisches Feintuning ────────────────────────────────
;; Python: black/ruff on-save lieber via LSP? (+format-with-lsp t oben reicht oft)
;; Lua: stylua via LSP-Server, oder extern falls du später Apheleia nutzt.
;; Nix: nixd (oder nil) – du hast (nix +lsp) aktiv.
